{"data":{"css":".preformatted {\n    font-family: monospace;\n    white-space: pre;\n}\n\n.red { \n  color: red;\n}","data":[],"name":"apt","js":"var me = this;\nvar ME = $('#'+me.UUID)[0];\n\nme.ready = function(){\n  $(ME).find('.allpeersbutton').click(function(){\n    $(ME).find('.updateresult').text(\"\");\n    $(ME).find('.updateerror').text(\"\");\n    var list = $(ME).find('.whichpeer').find('select').find('option');\n    var i = list.length;\n    while (i-->1){\n      var name = list[i].innerHTML;\n      var peer = list[i].value;\n      upgradePeer(peer, name);\n    }\n  });\n  $(ME).find('.all3button').click(function(){\n    $(ME).find('.updateresult').text(\"sending update command...\");\n    $(ME).find('.updateerror').text(\"\");\n    var peer = $(ME).find('.whichpeer').find('select').val();\n    if (peer == 'local') peer = null;\n    send_update(function(result){\n      if (result.status != 'ok') {\n        $(ME).find('.updateerror').text(result.msg);\n        $(ME).find('.updateresult').text(\"\");\n      }\n      else{\n        $(ME).find('.updateresult').text(result.data.out);\n        $(ME).find('.updateerror').text(result.data.err);\n        var list = result.data.err.split(\"\\n\");\n        var i = list.length;\n        while (i-->0) if (list[i].startsWith(\"E:\")) return;\n        $(ME).find('.updateresult').append('<br><br><i>listing updates...<\/i>');\n        send_list_available(function(result){\n          if (result.status != 'ok') {\n            $(ME).find('.updateerror').text(result.msg);\n            $(ME).find('.updateresult').text(\"\");\n          }\n          else{\n            $(ME).find('.updateresult').text(result.data.out);\n            $(ME).find('.updateerror').text(result.data.err);\n            var list = result.data.out.split(\"\\n\");\n            var i = list.length;\n            var n = 0;\n            while (i-->0) if (list[i].startsWith(\"Inst \")) n++;\n            if (n>0){\n              $(ME).find('.updateresult').html('<i>fetching '+n+' updates...<\/i>');\n              send_upgrade(function(result){\n                if (result.status != 'ok') {\n                  $(ME).find('.updateerror').text(result.msg);\n                  $(ME).find('.updateresult').text(\"\");\n                }\n                else{\n                  $(ME).find('.updateresult').text(result.data.out);\n                  $(ME).find('.updateerror').text(result.data.err);\n                }\n              }, peer);\n            }\n          }\n        }, peer);\n      }\n    }, peer);\n  });\n  $(ME).find('.updatebutton').click(function(){\n    $(ME).find('.updateresult').text(\"sending update command...\");\n    $(ME).find('.updateerror').text(\"\");\n    var peer = $(ME).find('.whichpeer').find('select').val();\n    if (peer == 'local') peer = null;\n    send_update(function(result){\n      if (result.status != 'ok') {\n        $(ME).find('.updateerror').text(result.msg);\n        $(ME).find('.updateresult').text(\"\");\n      }\n      else{\n        $(ME).find('.updateresult').text(result.data.out);\n        $(ME).find('.updateerror').text(result.data.err);\n      }\n    }, peer);\n  });\n  $(ME).find('.upgradebutton').click(function(){\n    $(ME).find('.updateresult').text(\"sending upgrade command...\");\n    $(ME).find('.updateerror').text(\"\");\n    var peer = $(ME).find('.whichpeer').find('select').val();\n    if (peer == 'local') peer = null;\n    send_upgrade(function(result){\n      if (result.status != 'ok') {\n        $(ME).find('.updateerror').text(result.msg);\n        $(ME).find('.updateresult').text(\"\");\n      }\n      else{\n        $(ME).find('.updateresult').text(result.data.out);\n        $(ME).find('.updateerror').text(result.data.err);\n      }\n    }, peer);\n  });\n  $(ME).find('.listbutton').click(function(){\n    $(ME).find('.updateresult').text(\"sending list_available command...\");\n    $(ME).find('.updateerror').text(\"\");\n    var peer = $(ME).find('.whichpeer').find('select').val();\n    if (peer == 'local') peer = null;\n    send_list_available(function(result){\n      if (result.status != 'ok') {\n        $(ME).find('.updateerror').text(result.msg);\n        $(ME).find('.updateresult').text(\"\");\n      }\n      else{\n        $(ME).find('.updateresult').text(result.data.out);\n        $(ME).find('.updateerror').text(result.data.err);\n      }\n    }, peer);\n  });\n  $(ME).find('.osinfobutton').click(function(){\n    $(ME).find('.updateresult').text(\"sending os_info command...\");\n    $(ME).find('.updateerror').text(\"\");\n    var peer = $(ME).find('.whichpeer').find('select').val();\n    if (peer == 'local') peer = null;\n    send_os_info(function(result){\n      if (result.status != 'ok') {\n        $(ME).find('.updateerror').text(result.msg);\n        $(ME).find('.updateresult').text(\"\");\n      }\n      else{\n        var s = '';\n        for (var key in result.data)\n          s += key + ': ' + result.data[key] + '<br>';\n        $(ME).find('.updateresult').html(s);\n        $(ME).find('.updateerror').text(\"\");\n      }\n    }, peer);\n  });\n  $(ME).find('.listallbutton').click(function(){\n    $(ME).find('.updateresult').text(\"\");\n    $(ME).find('.updateerror').text(\"\");\n    var list = $(ME).find('.whichpeer').find('select').find('option');\n    var i = list.length;\n    while (i-->1){\n      var name = list[i].innerHTML;\n      var peer = list[i].value;\n      check_os(peer, name);\n    }\n  });\n};\n\nfunction extractErrors(msg){\n  var list = msg.split(\"\\n\");\n  var i = list.length;\n  var list2 = [];\n  while (i-->0) if (list[i].startsWith(\"E:\")) list2.push(list[i]);\n  return list2;\n}\n\nfunction extractUpdates(msg){\n  var n = 0;\n  var list = msg.split(\"\\n\");\n  var i = list.length;\n  while (i-->0) if (list[i].startsWith(\"Inst \")) n++;\n  return n;\n}\n\nfunction displayErrors(el, list){\n  el.html('');\n  i = list.length;\n  while (i-->0){\n    el.append('<br>'+red(list[i]));\n  }\n}\n\nfunction upgradePeer(peer, name){\n  $(ME).find('.updateresult').append(name+\": <span id='up_\"+peer+\"'><i>Updating package lists...<\/i><\/span><br>\");\n  send_update(function(result){\n    var el = $(ME).find('#up_'+peer);\n    if (result.status != 'ok') el.html('<br>'+red(result.msg));\n    else{\n      var list = extractErrors(result.data.err);\n      if (list.length>0) displayErrors(el, list);\n      else{\n        el.html('<i>Calculating available updates...<\/i>');\n        send_list_available(function(result){\n          if (result.status != 'ok') el.html('<br>'+red(result.msg));\n          else{\n            var list = extractErrors(result.data.err);\n            if (list.length>0) displayErrors(el, list);\n            else{\n              var n = extractUpdates(result.data.out);\n              if (n == 0) el.html('OK');\n              else {\n                el.html('<i>fetching '+n+' updates...<\/i>');\n                send_upgrade(function(result){\n                  if (result.status != 'ok') el.html('<br>'+red(result.msg));\n                  else{\n                    var list = extractErrors(result.data.err);\n                    if (list.length>0) displayErrors(el, list);\n                    else el.html('OK ('+n+' updated)');\n                  }\n                }, peer);\n              }\n            }\n          }\n        }, peer);\n      }\n    }\n  }, peer);\n}\n\nfunction check_os(peer, name){\n  $(ME).find('.updateresult').append(\"<div id='os_\"+peer+\"'><i>Checking OS on \"+name+\"...<\/i><\/div>\");\n  send_os_info(function(result){\n    console.log(result);\n    var el = $(ME).find('#os_'+peer);\n    if (result.status != 'ok')\n      el.html(red(name+' = '+result.msg));\n    else{\n      el.text(name+' = '+result.data.PRETTY_NAME);\n    }\n  }, peer);\n}\n\nfunction red(msg){\n  return \"<font color='red'>\"+msg+\"<\/font>\";\n}\n","groups":"","ctl":"prnooo17c22981ca5z1c","html":"<div class='whichpeer data-control' data-control='peerbot:selectpeer:{\"connectedonly\":true,\"local\":true}'><\/div>\n<button class=\"updatebutton mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect\">\n  update\n<\/button>\n<button class=\"listbutton mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect\">\n  list\n<\/button>\n<button class=\"upgradebutton mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect\">\n  upgrade\n<\/button>\n-\n<button class=\"all3button mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect\">\n  all 3\n<\/button>\n<button class=\"allpeersbutton mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect\">\n  all peers\n<\/button>\n<br>\n<button class=\"osinfobutton mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect\">\n  os info\n<\/button>\n<button class=\"listallbutton mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect\">\n  list all\n<\/button>\n<br><br>\n<div class='updateresult preformatted'><\/div>\n<div class='updateerror preformatted red'><\/div>","cmd":[{"java":"tjjtmx17c22984f11l1d","name":"update","id":"wrlgli17c22984f15z1e"},{"java":"gyjgjx17c22dfde91p40","name":"upgrade","id":"livlzh17c22dfde94s41"},{"java":"tizuli17c3cb88c80s1b","name":"list_available","id":"ossiwo17c3cb88c86z1c"},{"java":"xumplz17c41df93b6v5f","name":"os_info","id":"jqhnkr17c41df93b9o60"}],"three":{"controls":[],"assets":[],"behaviors":[],"animations":[],"poses":[]},"db":"raspberrypi","desc":""},"id":"prnooo17c22981ca5z1c","sessionid":"jvgvwg16b7a4d277bt3","time":1633283000359,"addr":"/0:0:0:0:0:0:0:1:50078","username":"admin"}