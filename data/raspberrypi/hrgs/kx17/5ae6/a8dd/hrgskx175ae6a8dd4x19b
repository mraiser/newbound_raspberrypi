{"data":{"css":".dvrwrap{\n  display:inline-block;\n  background-color:black;\n  color:white;\n}\n\n.mediagoeshere{\n  position:relative;\n}\n\n.overimage{\n  position:absolute;\n  top:0px;\n  left:0px;\n  width:100%;\n  height:100%;\n  display:none;\n}\n\n.tab3 {\n  width:33%;\n}\n\n.live{\n  max-width:100%;\n}\n\n.dvrwrap .mdl-tabs__tab {\n  color: rgba(255,255,255,.54);\n}\n\n.dvrwrap .mdl-tabs.is-upgraded .mdl-tabs__tab.is-active {\n    color: rgba(255,255,255,.87);\n}\n\n.dvrwrap table{\n  color:white;\n}\n\n.dvrwrap .mdl-slider__background-upper{\n  background: rgba(255,255,255,.26);\n}\n\n.timeselect select{\n  background-color:black;\n  color: white;\n}\n\n.dvryearselect{\n  width:60px;\n}\n\n.dvrmonthselect{\n  width:90px;\n}\n\n.dvrdateselect, .dvrhourselect, .dvrminselect, .dvrsecselect {\n  width:40px;\n}\n\n.dvryearselect, .dvrmonthselect, .dvrdateselect, .dvrhourselect, .dvrminselect, .dvrsecselect {\n  display:inline-block;\n}\n\n.floatrightbutton{\n  float:right;\n  margin-left:20px;\n}\n\n.thumbsliderwrap, .eventsliderwrap{\n  position:relative;\n  display:inline-block;\n  width:100%;\n  overflow-x:scroll;\n  overflow-y:hidden;\n  height:102px\n}\n\n.thumbslider, .eventslider{\n  white-space:nowrap;\n  position:absolute;\n}\n\n.rvctable ::-webkit-scrollbar {\n  height: 3px;\n}\n\n.rvctable ::-webkit-scrollbar-track {\n  background: #fff2; \n}\n\n.rvctable ::-webkit-scrollbar-thumb {\n  background: #888; \n}\n\n.rvctable ::-webkit-scrollbar-thumb:hover {\n  background: #555; \n}\n\n.thumbtimestamp, .thumbduration {\n  position: absolute;\n  font-weight:900;\n  font-size:medium;\n  text-shadow:\n     -1px -1px 0 #000,  \n      1px -1px 0 #000,\n      -1px 1px 0 #000,\n       1px 1px 0 #000;\n}\n\n.thumbtimestamp{\n  bottom:0px;\n}\n\n.thumbduration{\n  top:0px;\n  right:0px;\n}\n\n","data":[],"name":"dvr","js":"var monthnames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];\n\nvar me = this;\nvar ME = $('#'+me.UUID)[0];\n\nif (ME.DATA.peer){\n  if (ME.DATA.peer != 'local') me.peer = ME.DATA.peer;\n}\nelse me.peer = typeof CURRENTDEVICEID == 'undefined' ? null : CURRENTDEVICEID;\n\n//me.peer = \"56ef9ae2-6fd9-40f7-8f46-0a3bcc711da5\";\n\nME.DATA.peer = me.peer;\nme.prefix = me.peer ? '../peerbot/remote/'+me.peer+'/' : '../';\n\nme.ready = function(){\n  componentHandler.upgradeAllRegistered();\n  var el = $(ME).find('.mediagoeshere');\n  ME.DATA.update = 3000;\n  installControl(el[0], 'raspberrypi', 'cameramodule', function(api){\n    me.CAM = api;\n    el.append('<div class=\"overimage\"><video class=\"rv-event-video hideme\" controls=\"true\" autoplay=\"true\" allowfullscreen=\"true\" width=\"100%\" height=\"100%\" style=\"background-color:black;\"><\/video><\/div>');\n  }, ME.DATA);\n}\n\nfunction updateSlide(){\n  var year = $(ME).find('.dvryearselect').find('select').val();\n  var month = $(ME).find('.dvrmonthselect').find('select').val();\n  var date = $(ME).find('.dvrdateselect').find('select').val();\n  var hour = $(ME).find('.dvrhourselect').find('select').val();\n  var min = $(ME).find('.dvrminselect').find('select').val();\n  var sec = $(ME).find('.dvrsecselect').find('select').val();\n\n  var nudate = new Date(year, month, date, hour, Number(min), Number(sec), 0);\n  me.dvrtime = nudate.getTime();\n  buildTimePicker();\n  \n  var p = (me.dvrtime - me.CAM.info.first.time) / (me.CAM.info.last.time - me.CAM.info.first.time);\n  $(ME).find('.datetimeslider').val(p*100)[0].MaterialSlider.change();\n}\n\nfunction buildTimePicker(){\n  var start = new Date(me.CAM.info.first.time);\n  var stop = new Date(me.CAM.info.last.time);\n  \n  if (!me.dvrtime) me.dvrtime = me.CAM.info.last.time;\n  else if (me.dvrtime < me.CAM.info.first.time) me.dvrtime = me.CAM.info.first.time;\n  else if (me.dvrtime > me.CAM.info.last.time) me.dvrtime = me.CAM.info.last.time;\n  var current = new Date(me.dvrtime);\n\n  ME.DATA.update = false;\n  me.CAM.loadSnap(me.dvrtime, function(){\n    $(ME).find('.timestamp').css('color', 'white');\n  }, 0, true);\n  \n  var startyear = start.getFullYear();\n  var stopyear = stop.getFullYear();\n  var currentyear = current.getFullYear();\n  var years = [];\n  for (var i=startyear; i<stopyear+1; i++) years.push(i);\n  var d = {\n    \"list\": years,\n    \"value\": \"\"+currentyear,\n    \"label\": \"Year\",\n    \"cb\": updateSlide\n  }\n  var el = $(ME).find('.dvryearselect');\n  installControl(el[0], 'metabot', 'select', function(api){}, d);\n  \n  var currentmonth = current.getMonth();\n  var months = [];\n  for (var i=0; i<12; i++){\n    var mstart = new Date(currentyear, i, 1, 0, 0, 0, 0);\n    var mend = new Date(currentyear, i+1, 1, 0, 0, 0, -1);\n    var mst = mstart.getTime();\n    var met = mend.getTime();\n    if (met>me.CAM.info.first.time && mst<me.CAM.info.last.time){\n      d = {\n        \"id\": \"\"+i,\n        \"name\": monthnames[i]\n      };\n      months.push(d);\n    }\n  }\n  d = {\n    \"list\": months,\n    \"value\": \"\"+currentmonth,\n    \"label\": \"Month\",\n    \"cb\": updateSlide\n  };\n  el = $(ME).find('.dvrmonthselect');\n  installControl(el[0], 'metabot', 'select', function(api){}, d);\n  \n  var currentdate = current.getDate();\n  var sdate = mstart.getDate();\n  var edate = mend.getDate()+1;\n  var dates = [];\n  for (var i=sdate;i<edate;i++){\n    var dstart = new Date(currentyear, currentmonth, i, 0, 0, 0, 0);\n    var dend = new Date(currentyear, currentmonth, i+1, 0, 0, 0, -1);\n    var dst = dstart.getTime();\n    var det = dend.getTime();\n    if (det>me.CAM.info.first.time && dst<me.CAM.info.last.time) {\n      dates.push(\"\"+i);\n    }\n  }\n  d = {\n    \"list\": dates,\n    \"value\": \"\"+currentdate,\n    \"label\": \"Date\",\n    \"cb\": updateSlide\n  };\n  el = $(ME).find('.dvrdateselect');\n  installControl(el[0], 'metabot', 'select', function(api){}, d);\n  \n  var currenthour = current.getHours();\n  var hours = [];\n  for (var i=0; i<24; i++){\n    var dstart = new Date(currentyear, currentmonth, currentdate, i, 0, 0, 0);\n    var dend = new Date(currentyear, currentmonth, currentdate, i+1, 0, 0, -1);\n    var dst = dstart.getTime();\n    var det = dend.getTime();\n    if (det>me.CAM.info.first.time && dst<me.CAM.info.last.time) {\n      hours.push(\"\"+i);\n    }\n  }\n  d = {\n    \"list\": hours,\n    \"value\": \"\"+currenthour,\n    \"label\": \"Hour\",\n    \"cb\": updateSlide\n  };\n  el = $(ME).find('.dvrhourselect');\n  installControl(el[0], 'metabot', 'select', function(api){}, d);\n  \n  var currentmin = current.getMinutes();\n  var minutes = [];\n  for (var i=0; i<60; i++){\n    var dstart = new Date(currentyear, currentmonth, currentdate, currenthour, i, 0, 0);\n    var dend = new Date(currentyear, currentmonth, currentdate, currenthour, i+1, 0, -1);\n    var dst = dstart.getTime();\n    var det = dend.getTime();\n    if (det>me.CAM.info.first.time && dst<me.CAM.info.last.time) {\n      minutes.push(\"\"+padZero(i));\n    }\n  }\n  d = {\n    \"list\": minutes,\n    \"value\": \"\"+padZero(currentmin),\n    \"label\": \"Minute\",\n    \"cb\": updateSlide\n  };\n  el = $(ME).find('.dvrminselect');\n  installControl(el[0], 'metabot', 'select', function(api){}, d);\n  \n  var currentsec = current.getSeconds();\n  var seconds = [];\n  for (var i=0; i<60; i++){\n    var dstart = new Date(currentyear, currentmonth, currentdate, currenthour, currentmin, i, 0);\n    var dend = new Date(currentyear, currentmonth, currentdate, currenthour, currentmin, i+1, -1);\n    var dst = dstart.getTime();\n    var det = dend.getTime();\n    if (det>me.CAM.info.first.time && dst<me.CAM.info.last.time) {\n      seconds.push(\"\"+padZero(i));\n    }\n  }\n  d = {\n    \"list\": seconds,\n    \"value\": \"\"+padZero(currentsec),\n    \"label\": \"Second\",\n    \"cb\": updateSlide\n  };\n  el = $(ME).find('.dvrsecselect');\n  installControl(el[0], 'metabot', 'select', function(api){}, d);\n \n  buildThumbs();\n};\n\nfunction addAllFrames(el, list){\n  if (list.length>0){\n    var tstart = list.shift();\n    var img = buildThumb(tstart, function(){\n      addAllFrames(el, list);\n    });\n    img.data('timestamp', tstart);\n    img.addClass('clickthumb');\n    img.click(function(){\n      $(ME).find('.clickthumb').css('border', 'thin solid black');\n      $(this).css('border', 'thin solid #83bc00');\n      me.CAM.loadSnap($(this).data('timestamp'), null, 0, true);\n    });\n    el.append(img).parent()[0].scrollLeft += 130;\n  }\n}\n\nfunction buildThumbs(){\n  var tstart = me.dvrtime;\n  var dur = $(ME).find('.durationslider').val()*1000;\n  var tstop = Math.min(tstart + dur, me.CAM.info.last.time)+1;\n  el = $(ME).find('.thumbslider');\n  el.empty();\n  var list = [];\n  while (tstart < tstop){\n    list.push(tstart);\n    tstart += 5000;\n  }    \n  if (me.addingevents) me.addingevents.length = 0;\n  if (me.addingframes) me.addingframes.length = 0;\n  me.addingframes = list;\n  addAllFrames(el, list);\n  setTimeout(function(){ addAllFrames(el, list); }, 1000);\n  setTimeout(function(){ addAllFrames(el, list); }, 2000);\n}\n\n$(ME).find('.dvrtab').click(buildTimePicker);\n$(ME).find('.livetab').click(function(){\n  ME.DATA.update = 3000;\n  $(ME).find('.timestamp').html('<i>loading...<\/i>').css('color', '#83bc00');\n});\n\nfunction addAllEvents(el, list){\n  if (list.length>0){\n    var d = list.pop();\n    var event = buildThumb(d.time, function(){\n      addAllEvents(el, list);\n    });\n    var secs = Math.floor((d.list[d.list.length-1].time - d.time)/1000);\n    var mins = Math.floor(secs/60);\n    secs = padZero(secs % 60);\n\n    event.data('event', d);\n    event.addClass('clickevent');\n    el.prepend(event).parent()[0].scrollLeft += 130;\n    event.click(function(){\n      $(ME).find('.clickevent').css('border', 'thin solid black');\n      $(this).css('border', 'thin solid #83bc00');\n      var d = $(this).data('event');\n      me.dvrtime = d.time;\n      buildTimePicker();\n      var dur = Math.floor((d.list[d.list.length-1].time - d.time)/1000);\n      console.log(dur);\n      $(ME).find('.durationslider').val(dur).change()[0].MaterialSlider.change();\n      $(ME).find('.dvrplaybutton').click();\n    });\n\n    var el5 = '<div class=\"thumbduration\">'+mins+\":\"+secs+'<\/div>';\n    event.append(el5);\n  }\n}\n\n$(ME).find('.eventstab').click(function(){\n  device_events(me.CAM.info.first.time, me.CAM.info.last.time, function(result){\n    var el = $(ME).find('.eventslider');\n    el.empty();\n    \n    if (me.addingevents) me.addingevents.length = 0;\n    me.addingevents = result.data.list;\n    \n    addAllEvents(el, result.data.list);\n    setTimeout(function(){ addAllEvents(el, result.data.list); }, 1000);\n    setTimeout(function(){ addAllEvents(el, result.data.list); }, 2000);\n  });\n});\n\n$(ME).find('.datetimeslider').change(function(){\n  var p = $(this).val()/100;\n  me.dvrtime = Math.floor(me.CAM.info.first.time + (p * (me.CAM.info.last.time - me.CAM.info.first.time)));\n  buildTimePicker();\n});\n\n$(ME).find('.durationslider').change(function(){\n  var secs = $(this).val();\n  var mins = Math.floor(secs/60);\n  secs = padZero(secs % 60);\n  $(ME).find('.durationslidervalue').text(mins+\":\"+secs);\n  buildThumbs();\n});\n\nfunction parseTime(d){\n  return parseDate(d)+':'+padZero(d.getSeconds());\n}\n\nfunction buildThumb(millis, cb){\n  var url = me.CAM.previewPath(millis);\n  var time = parseTime(new Date(millis));\n  console.log(time);\n  var el1 = $('<div style=\"position:relative;display:inline-block;border:thin solid black;\"><\/div>');\n  var el2 = $('<img width=\"128px\" height=\"96px\" src=\"../botmanager/asset/raspberrypi/loading_trippy.gif\">');\n  var el3 = $('<img style=\"display:none;\">');\n  var el4 = '<div class=\"thumbtimestamp\">'+time+'<\/div>';\n  el3.load(function(){\n    el2.prop('src', url);\n    if (cb) cb();\n  });\n  el3.error(function(){\n    console.log(\"COULDN'T LOAD \"+url);\n    el2.prop('src', '../botmanager/asset/raspberrypi/nosignal.jpg');\n    if (cb) cb();\n  });\n  el3.prop('src', url);\n  el1.append(el2);\n  el1.append(el3);\n  el1.append(el4);\n  \n  return el1;\n}\n\n$(ME).find('.dvrplaybutton').click(function(){\n  var el = $(ME).find('.live')[0];\n  $(el).prop(\"src\", \"../botmanager/asset/raspberrypi/processing.gif\");\n  \n  var start = me.dvrtime;\n  var dur = $(ME).find('.durationslider').val()*1000;\n  transcode(start, dur, function(url){\n    var vid = $(ME).find(\"video\")[0];\n    $(vid).prop('poster', me.CAM.previewPath(start));\n    $(vid).parent().css('display', 'block');\n    vid.src = url;\n    vid.play();\n  });\n});\n\n$(ME).find('.dvrdownloadbutton').click(function(){\n  var el = $(ME).find('.live')[0];\n  var oldsrc = $(el).prop(\"src\");\n  $(el).prop(\"src\", \"../botmanager/asset/raspberrypi/processing.gif\");\n  \n  var start = me.dvrtime;\n  var dur = $(ME).find('.durationslider').val()*1000;\n  transcode(start, dur, function(url){\n    var name = url.substring(url.lastIndexOf('/')+1);\n    var clickme = $('<a class=\"overimage\" download=\"'+name+'\"><img src=\"../botmanager/asset/raspberrypi/download.png\"><\/a>');\n    clickme.css('display', 'block');\n    clickme.prop('href', url);\n    clickme.click(function(){\n      $(el).prop(\"src\", oldsrc);\n      $('.overimage').css('display', 'none');\n      buildTimePicker();\n    });\n    $(ME).find('.mediagoeshere').append(clickme);\n  });\n});\n\nfunction transcode(start, dur, cb){\n  var stop = start + dur;\n  var format = 'mp4';\n  device_build(start, stop, format, function(result){\n    var src = me.prefix+'raspberrypi/generated/mp4/'+result.data.name;\n    cb(src);\n  });\n}\n\nfunction device_build(start, stop, format, cb){\n  var args = {start: start, stop: stop, format: format};\n  args = encodeURIComponent(JSON.stringify(args));\n  json(me.prefix+'metabot/call', 'db=raspberrypi&name=cameramodule&cmd=build&args='+args, function(result){\n    cb(result);\n  });\n}\n\nfunction device_events(start, stop, cb){\n  var args = {start: start, stop: stop};\n  args = encodeURIComponent(JSON.stringify(args));\n  $.getJSON(me.prefix+'metabot/call?db=raspberrypi&name=cameramodule&cmd=events&args='+args, function(result){\n    cb(result);\n  });\n}\n\n\n\n\n\n","groups":"camera","ctl":"hrgskx175ae6a8dd4x19b","html":"<div class='dvrwrap color-primary-dark'>\n  <div class='mediagoeshere'><\/div>\n  <div class = \"mdl-tabs mdl-js-tabs\">\n    <div class = \"mdl-tabs__tab-bar\">\n      <a href = \"#tab1-panel\" class = \"livetab tab3 mdl-tabs__tab is-active\">Live<\/a>\n      <a href = \"#tab2-panel\" class = \"dvrtab tab3 mdl-tabs__tab\">DVR<\/a>\n      <a href = \"#tab3-panel\" class = \"eventstab tab3 mdl-tabs__tab\">Events<\/a>\n    <\/div>\n\n    <div class = \"mdl-tabs__panel is-active\" id = \"tab1-panel\">\n    <\/div>\n\n    <div class = \"mdl-tabs__panel\" id = \"tab2-panel\">\n      <table border='0' cellpadding='0' cellspacing='20' width='100%' class='rvctable'>\n        <tr>\n          <td colspan=\"2\">\n            <div class='thumbsliderwrap'>\n              <div class='thumbslider'><\/div>\n            <\/div>\n          <\/td>\n        <\/tr>\n        <tr>\n          <td width='140px'>Duration: <span class='durationslidervalue'>0:05<\/span><\/td>\n          <td class='rv-durationslider'>\n            <input class=\"mdl-slider mdl-js-slider durationslider\" type=\"range\"\n  min=\"5\" max=\"300\" value=\"5\" tabindex=\"0\">\n          <\/td>\n        <\/tr>\n        <tr>\n          <td width='140px'>Date/Time:<\/td>\n          <td class='rv-whenslider'>\n            <input class=\"mdl-slider mdl-js-slider datetimeslider\" type=\"range\"\n  min=\"0\" max=\"100\" value=\"100\" tabindex=\"0\">\n          <\/td>\n        <\/tr>\n        <tr>\n          <td colspan=\"2\">\n            <div class='dvryearselect timeselect'><\/div>\n            <div class='dvrmonthselect timeselect'><\/div>\n            <div class='dvrdateselect timeselect'><\/div>\n            <div class='dvrhourselect timeselect'><\/div>:&nbsp;&nbsp;\n            <div class='dvrminselect timeselect'><\/div>:&nbsp;&nbsp;\n            <div class='dvrsecselect timeselect'><\/div>\n            \n<button class=\"mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored floatrightbutton dvrplaybutton\">\n  Play\n<\/button>\n<button class=\"mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored floatrightbutton dvrdownloadbutton\">\n  Download\n<\/button>            \n            \n          <\/td>\n        <\/tr>\n      <\/table>\n    <\/div>\n\n    <div class = \"mdl-tabs__panel\" id = \"tab3-panel\">\n      <table border='0' cellpadding='0' cellspacing='20' width='100%' class='rvctable'>\n        <tr>\n          <td colspan=\"2\">\n            <div class='eventsliderwrap'>\n              <div class='eventslider'><\/div>\n            <\/div>\n          <\/td>\n        <\/tr>\n      <\/table>\n    <\/div>\n  <\/div>\n<\/div>","three":{"controls":[]},"db":"raspberrypi","desc":""},"readers":["camera"],"id":"hrgskx175ae6a8dd4x19b","sessionid":"jvgvwg16b7a4d277bt3","time":1611503854318,"addr":"/0:0:0:0:0:0:0:1:34172","username":"admin"}